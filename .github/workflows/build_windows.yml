name: Windows Build and Test

on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

    - name: Build project
      if: success()
      run: npm run build

    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist

    - name: Report status
      if: always()
      uses: actions/github-script@v6
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const { owner, repo } = context.repo;
          const run_id = context.runId;
          const run_url = `https://github.com/${owner}/${repo}/actions/runs/${run_id}`;
          const status = '${{ job.status }}';
          
          try {
            await github.rest.repos.createCommitStatus({
              owner: owner,
              repo: repo,
              sha: context.sha,
              state: status.toLowerCase(),
              target_url: run_url,
              description: `Build and test ${status.toLowerCase()}`,
              context: 'Windows Build and Test'
            });
          } catch (error) {
            console.error('Failed to create commit status:', error.message);
            core.setFailed('Failed to create commit status');
          }